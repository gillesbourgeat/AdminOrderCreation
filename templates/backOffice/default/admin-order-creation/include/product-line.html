<tr>
    <td>
        {form_field field='product_id' value_key=$key}
        {$product_id = $data[$key]}
        <div class="form-group">
            <select class="form-control js-select-product" name="{$name}" data-placeholder="{intl l="Search..." d="adminordercreation.bo.default"}" data-url="{url path="/admin/admin-order-creation/ajax/search/product"}">
                {if $product_id}
                    {loop type="product" name="product-$key" id=$product_id visible="*"}
                        <option value="{$ID}">{$REF} : {$TITLE}</option>
                    {/loop}
                {/if}
            </select>
        </div>
        {/form_field}
    </td>
    <td>
        {form_field field='product_sale_element_id' value_key=$key}
        <div class="form-group">
            {if $product_id}
                {$attributeCombinations = []}
                {$PSE_first = null}
                {loop type="product_sale_elements" name="product-sale-element-$key" product=$product_id currency=$currency_id}
                    {$PSE_id = $ID}
                    {if !$PSE_first}
                        {$PSE_first = $ID}
                    {/if}
                    {loop type="attribute_combination" name="attribute-combination-$key" product_sale_elements=$ID}
                        {$attributeCombinations[$PSE_id][] = $ATTRIBUTE_TITLE|cat:' : '|cat:$ATTRIBUTE_AVAILABILITY_TITLE}
                    {/loop}
                {/loop}

                {if $attributeCombinations|count}
                    <select class="form-control js-select-product-sale-element" name="{$name}" >
                        {loop type="product_sale_elements" name="product-sale-element-$key" product=$product_id currency=$currency_id}
                            {$selected = false}
                            {if !$data[$key] and $PSE_first == $ID}
                                {$productSaleEmenetIdSelected = $ID}
                                {$selected = true}
                            {elseif $data[$key] == $ID}
                                {$productSaleEmenetIdSelected = $ID}
                                {$selected = true}
                            {elseif $PSE_first == $ID}
                                {$productSaleEmenetIdSelected = $ID}
                                {$selected = true}
                            {/if}

                            <option {if $selected}selected{/if} data-quantity="{$QUANTITY}" data-ref="{$REF}" data-color="{if $QUANTITY > 0}#e6ffe6{else}#ffe6e6{/if}" value="{$ID}" >
                                {', '|implode:$attributeCombinations[$ID]}
                            </option>
                        {/loop}
                    </select>
                {else}
                    --
                    {loop type="product_sale_elements" name="product-sale-element-$key" product=$product_id limit=1 currency=$currency_id}
                        {$productSaleEmenetIdSelected = $ID}
                        <input type="hidden" value="{$ID}" name="{$name}" />
                   {/loop}
                {/if}
            {/if}
        </div>
        {/form_field}
    </td>
    <td>
        {$quantity = 1}
        {form_field field='product_quantity' value_key=$key}

        {if $data[$key]}
            {$quantity = {$data[$key]}}
        {/if}

        <div class="form-group">
            {if $product_id}
                {loop type="product_sale_elements" name="product-sale-element-quanaity-$key" id=$productSaleEmenetIdSelected currency=$currency_id}
                <input class="form-control js-action-refresh" type="number" min="1" step="1" max="{$QUANTITY}" name="{$name}" value="{$quantity}" />
                {/loop}
            {/if}
        </div>
        {/form_field}
    </td>
    <td>
        {$reduction = 0}
        {form_field field='product_reduction' value_key=$key}
        {if $data[$key]}
            {$reduction = {$data[$key]}}
        {/if}
        <div class="form-group">
            <input class="form-control js-action-refresh" type="number" min="0" step="0.01" name="{$name}" value="{$reduction}" />
        </div>
        {/form_field}

        {$reductionType = 1}
        {form_field field='product_reduction_type' value_key=$key}
        {if $data[$key]}
            {$reductionType = {$data[$key]}}
        {/if}
        <div class="form-group">
            <select class="form-control js-action-refresh" name="{$name}">
                <option value="1" {if $data[$key] == 1}selected{/if}>{intl l="Percentage" d="adminordercreation.bo.default"}</option>
                {*<option value="2" {if $data[$key] == 2}selected{/if}>{intl l="Global amount" d="adminordercreation.bo.default"}</option>
                <option value="3" {if $data[$key] == 3}selected{/if}>{intl l="Unit amount" d="adminordercreation.bo.default"}</option>*}
            </select>
        </div>
        {/form_field}
    </td>
    <td>
        {if $productSaleEmenetIdSelected}
        {loop type="product_sale_elements" name="product-sale-element-price-$key" id=$productSaleEmenetIdSelected currency=$currency_id}
            {if $IS_PROMO}
                {$price = {admin_order_creation_calc_reduction reduction=$reduction reduction_type=$reductionType price={$PROMO_PRICE + $PROMO_PRICE_TAX} quantity=$quantity}}
                {$priceWithoutTax = {admin_order_creation_calc_reduction reduction=$reduction reduction_type=$reductionType price=$PROMO_PRICE quantity=$quantity}}

                {format_money number=$price currency_id=$currency_id} TTC / {intl l="unt" d="adminordercreation.bo.default"}
                <br/>{format_money number={$price * $quantity} currency_id=$currency_id} TTC
                <br/>{format_money number=$priceWithoutTax currency_id=$currency_id} HT / {intl l="unt" d="adminordercreation.bo.default"}
                <br/>{format_money number={$priceWithoutTax * $quantity} currency_id=$currency_id} HT
            {else}
                {$price = {admin_order_creation_calc_reduction reduction=$reduction reduction_type=$reductionType price={$PRICE + $PRICE_TAX} quantity=$quantity}}
                {$priceWithoutTax = {admin_order_creation_calc_reduction reduction=$reduction reduction_type=$reductionType price=$PRICE quantity=$quantity}}

                {format_money number=$price currency_id=$currency_id} TTC / {intl l="unt" d="adminordercreation.bo.default"}
                <br/>{format_money number={$price * $quantity} currency_id=$currency_id} TTC
                <br/>{format_money number=$priceWithoutTax currency_id=$currency_id} HT / {intl l="unt" d="adminordercreation.bo.default"}
                <br/>{format_money number={$priceWithoutTax * $quantity} currency_id=$currency_id} HT
            {/if}
        {/loop}
        {/if}
    </td>
    <td>
        <button class="btn btn-danger js-action-delete" title="{intl l="Delete" d="adminordercreation.bo.default"}">
            <span class="glyphicon glyphicon-trash"></span>
        </button>
    </td>
</tr>